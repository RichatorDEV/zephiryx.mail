<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zephiryx Mail</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/jwt-decode.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; }
    .modern-button { border-radius: 9999px; }
    .container { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const API_URL = 'https://zephiryxmail-production.up.railway.app';
      const [user, setUser] = useState(null);
      const [accounts, setAccounts] = useState([]);
      const [currentAccount, setCurrentAccount] = useState(null);
      const [profile, setProfile] = useState(null);
      const [emails, setEmails] = useState([]);
      const [view, setView] = useState('login');
      const [registrationStep, setRegistrationStep] = useState(1);
      const [registrationData, setRegistrationData] = useState({ display_name: '', last_name: '', prefix: '', profile_picture: '' });
      const [emailData, setEmailData] = useState({ to: '', subject: '', body: '', is_draft: false });
      const [credentials, setCredentials] = useState({ username: '', password: '' });
      const [profileData, setProfileData] = useState({ display_name: '', profile_picture: '', password: '' });
      const [showRegister, setShowRegister] = useState(false);
      const [prefixAvailable, setPrefixAvailable] = useState(null);
      const [addAccountData, setAddAccountData] = useState({ email: '', password: '' });

      // Persist session
      useEffect(() => {
        const token = localStorage.getItem('token');
        if (token && window.jwtDecode) {
          try {
            // Use window.jwtDecode instead of window.jwt_decode
            const decoded = window.jwtDecode(token);
            setUser({ username: decoded.username, userId: decoded.userId });
            setView('inbox');
          } catch (error) {
            console.error('Error decoding token:', error);
            localStorage.removeItem('token');
          }
        } else if (!window.jwtDecode) {
          console.error('jwtDecode not loaded');
        }
      }, []);

      // Fetch accounts, profile, and emails
      useEffect(() => {
        if (user) {
          fetchAccounts();
          fetchProfile();
          if (['inbox', 'sent', 'spam', 'drafts'].includes(view)) {
            fetchEmails(view);
          }
        }
      }, [user, view, currentAccount]);

      // Check prefix availability
      useEffect(() => {
        if (registrationStep === 2 && registrationData.prefix) {
          checkPrefix(registrationData.prefix);
        }
      }, [registrationData.prefix]);

      const checkPrefix = async (prefix) => {
        try {
          const response = await axios.get(`${API_URL}/api/check_prefix?prefix=${prefix}`);
          setPrefixAvailable(response.data.available);
        } catch (error) {
          setPrefixAvailable(false);
          console.error('Error checking prefix:', error);
        }
      };

      const fetchAccounts = async () => {
        try {
          const response = await axios.get(`${API_URL}/api/accounts`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          setAccounts(response.data);
          if (!currentAccount && response.data.length > 0) {
            setCurrentAccount(response.data[0].email);
          }
        } catch (error) {
          console.error('Error al cargar cuentas:', error);
        }
      };

      const fetchProfile = async () => {
        try {
          const response = await axios.get(`${API_URL}/api/profile`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          setProfile(response.data);
        } catch (error) {
          console.error('Error al cargar perfil:', error);
        }
      };

      const fetchEmails = async (type) => {
        try {
          const response = await axios.get(`${API_URL}/api/emails/${type}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          setEmails(response.data);
        } catch (error) {
          console.error('Error al cargar correos:', error);
        }
      };

      const handleLogin = async () => {
        try {
          const response = await axios.post(`${API_URL}/api/login`, {
            username: credentials.username.split('@')[0], // Extract prefix
            password: credentials.password
          });
          localStorage.setItem('token', response.data.token);
          if (window.jwtDecode) {
            const decoded = window.jwtDecode(response.data.token);
            setUser({ username: decoded.username, userId: decoded.userId });
            setCredentials({ username: '', password: '' });
            setView('inbox');
          } else {
            throw new Error('jwtDecode not loaded');
          }
        } catch (error) {
          alert('Error al iniciar sesión: ' + (error.response?.data?.error || error.message));
        }
      };

      const handleRegister = async () => {
        try {
          const username = registrationData.prefix;
          const password = credentials.password;
          const display_name = `${registrationData.display_name} ${registrationData.last_name}`.trim();
          const profile_picture = registrationData.profile_picture || 
            `https://via.placeholder.com/100?text=${registrationData.display_name.charAt(0).toUpperCase()}&bg=3b82f6`;
          const response = await axios.post(`${API_URL}/api/register`, { 
            username, 
            password, 
            display_name, 
            profile_picture 
          });
          localStorage.setItem('token', response.data.token);
          if (window.jwtDecode) {
            const decoded = window.jwtDecode(response.data.token);
            setUser({ username: decoded.username, userId: decoded.userId });
            setRegistrationData({ display_name: '', last_name: '', prefix: '', profile_picture: '' });
            setCredentials({ username: '', password: '' });
            setView('inbox');
            setShowRegister(false);
            setRegistrationStep(1);
          } else {
            throw new Error('jwtDecode not loaded');
          }
        } catch (error) {
          alert('Error al registrar: ' + (error.response?.data?.error || error.message));
        }
      };

      const updateProfile = async () => {
        try {
          await axios.put(`${API_URL}/api/profile`, profileData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          alert('Perfil actualizado');
          fetchProfile();
          setProfileData({ display_name: '', profile_picture: '', password: '' });
        } catch (error) {
          alert('Error al actualizar perfil: ' + (error.response?.data?.error || error.message));
        }
      };

      const addAccount = async () => {
        try {
          await axios.post(`${API_URL}/api/accounts`, addAccountData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          alert('Cuenta añadida');
          fetchAccounts();
          setAddAccountData({ email: '', password: '' });
          setView('inbox');
        } catch (error) {
          alert('Error al añadir cuenta: ' + (error.response?.data?.error || error.message));
        }
      };

      const sendEmail = async () => {
        if (!currentAccount) {
          alert('Selecciona una cuenta antes de enviar');
          return;
        }
        try {
          await axios.post(`${API_URL}/api/emails`, {
            ...emailData,
            from: currentAccount
          }, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
          });
          setEmailData({ to: '', subject: '', body: '', is_draft: false });
          setView('inbox');
          fetchEmails('inbox');
        } catch (error) {
          alert('Error al enviar correo: ' + (error.response?.data?.error || error.message));
        }
      };

      const logout = () => {
        localStorage.removeItem('token');
        setUser(null);
        setCurrentAccount(null);
        setAccounts([]);
        setEmails([]);
        setView('login');
        setShowRegister(false);
      };

      return (
        <div className="min-h-screen bg-gray-50 flex flex-col items-center p-6">
          <div className="container">
            <h1 className="text-4xl font-bold mb-6 text-blue-600">Zephiryx Mail</h1>
            {view === 'login' && !user && (
              <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-lg mx-auto">
                <h2 className="text-2xl font-semibold mb-6 text-blue-600">
                  {showRegister ? 'Crear cuenta' : 'Iniciar Sesión'}
                </h2>
                {!showRegister ? (
                  <>
                    <input
                      type="text"
                      placeholder="Correo (ej: usuario@zephiryx.com)"
                      value={credentials.username}
                      onChange={(e) => setCredentials({ ...credentials, username: e.target.value })}
                      className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="password"
                      placeholder="Contraseña"
                      value={credentials.password}
                      onChange={(e) => setCredentials({ ...credentials, password: e.target.value })}
                      className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <div className="flex space-x-4">
                      <button
                        onClick={handleLogin}
                        className="flex-1 bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button"
                      >
                        Iniciar Sesión
                      </button>
                      <button
                        onClick={() => setShowRegister(true)}
                        className="flex-1 bg-green-600 text-white p-3 rounded-3xl hover:bg-green-700 modern-button"
                      >
                        Crear cuenta
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    {registrationStep === 1 && (
                      <>
                        <input
                          type="text"
                          placeholder="Nombre"
                          value={registrationData.display_name}
                          onChange={(e) => setRegistrationData({ ...registrationData, display_name: e.target.value })}
                          className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                          type="text"
                          placeholder="Apellidos (opcional)"
                          value={registrationData.last_name}
                          onChange={(e) => setRegistrationData({ ...registrationData, last_name: e.target.value })}
                          className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                          onClick={() => setRegistrationStep(2)}
                          disabled={!registrationData.display_name}
                          className="w-full bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button disabled:bg-gray-400"
                        >
                          Siguiente
                        </button>
                      </>
                    )}
                    {registrationStep === 2 && (
                      <>
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="Prefijo para @zephiryx.com"
                            value={registrationData.prefix}
                            onChange={(e) => setRegistrationData({ ...registrationData, prefix: e.target.value })}
                            className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <span className="absolute right-3 top-3 text-gray-500">@zephiryx.com</span>
                        </div>
                        {prefixAvailable !== null && (
                          <p className={prefixAvailable ? 'text-green-600 mb-4' : 'text-red-600 mb-4'}>
                            {prefixAvailable ? 'Disponible' : 'No disponible'}
                          </p>
                        )}
                        <input
                          type="password"
                          placeholder="Contraseña"
                          value={credentials.password}
                          onChange={(e) => setCredentials({ ...credentials, password: e.target.value })}
                          className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                          onClick={() => setRegistrationStep(3)}
                          disabled={!prefixAvailable || !credentials.password}
                          className="w-full bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button disabled:bg-gray-400"
                        >
                          Siguiente
                        </button>
                      </>
                    )}
                    {registrationStep === 3 && (
                      <>
                        <input
                          type="url"
                          placeholder="URL de la foto de perfil (opcional)"
                          value={registrationData.profile_picture}
                          onChange={(e) => setRegistrationData({ ...registrationData, profile_picture: e.target.value })}
                          className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                          onClick={handleRegister}
                          className="w-full bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button"
                        >
                          Finalizar Registro
                        </button>
                      </>
                    )}
                  </>
                )}
              </div>
            )}
            {user && (
              <div className="flex w-full">
                {/* Sidebar */}
                <div className="w-64 bg-white p-6 rounded-3xl shadow-lg mr-6">
                  <div className="flex items-center mb-6">
                    <img
                      src={profile?.profile_picture || `https://via.placeholder.com/40?text=${profile?.display_name?.charAt(0)?.toUpperCase() || 'U'}&bg=3b82f6`}
                      alt="Profile"
                      className="w-12 h-12 rounded-full mr-3"
                    />
                    <div>
                      <p className="font-semibold text-gray-800">{profile?.display_name || user.username}</p>
                      <select
                        value={currentAccount || ''}
                        onChange={(e) => setCurrentAccount(e.target.value)}
                        className="text-sm text-gray-600 bg-transparent border-none focus:outline-none"
                      >
                        {accounts.map((account) => (
                          <option key={account.email} value={account.email}>{account.email}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <button
                    onClick={() => setView('compose')}
                    className="w-full bg-blue-600 text-white p-3 rounded-3xl mb-4 hover:bg-blue-700 modern-button"
                  >
                    Redactar
                  </button>
                  <nav className="space-y-2">
                    <button
                      onClick={() => { setView('inbox'); fetchEmails('inbox'); }}
                      className={`w-full text-left p-3 rounded-3xl ${view === 'inbox' ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    >
                      Bandeja de entrada
                    </button>
                    <button
                      onClick={() => { setView('sent'); fetchEmails('sent'); }}
                      className={`w-full text-left p-3 rounded-3xl ${view === 'sent' ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    >
                      Enviados
                    </button>
                    <button
                      onClick={() => { setView('spam'); fetchEmails('spam'); }}
                      className={`w-full text-left p-3 rounded-3xl ${view === 'spam' ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    >
                      Spam
                    </button>
                    <button
                      onClick={() => { setView('drafts'); fetchEmails('drafts'); }}
                      className={`w-full text-left p-3 rounded-3xl ${view === 'drafts' ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    >
                      Borradores
                    </button>
                    <button
                      onClick={() => setView('profile')}
                      className={`w-full text-left p-3 rounded-3xl ${view === 'profile' ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    >
                      Perfil
                    </button>
                    <button
                      onClick={() => setView('add-account')}
                      className="w-full text-left p-3 rounded-3xl hover:bg-gray-100"
                    >
                      Añadir cuenta
                    </button>
                    <button
                      onClick={logout}
                      className="w-full text-left p-3 rounded-3xl text-red-600 hover:bg-gray-100"
                    >
                      Cerrar sesión
                    </button>
                  </nav>
                </div>
                {/* Main content */}
                <div className="flex-1">
                  {view === 'inbox' && (
                    <div className="bg-white p-8 rounded-3xl shadow-lg">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Bandeja de Entrada ({currentAccount})</h2>
                      <div className="space-y-4">
                        {emails.map((email) => (
                          <div key={email.id} className="p-4 border rounded-3xl hover:bg-gray-50">
                            <p><strong>De:</strong> {email.from_email}</p>
                            <p><strong>Asunto:</strong> {email.subject}</p>
                            <p className="truncate">{email.body}</p>
                            <p className="text-sm text-gray-500">{new Date(email.sent_at).toLocaleString()}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {view === 'sent' && (
                    <div className="bg-white p-8 rounded-3xl shadow-lg">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Enviados ({currentAccount})</h2>
                      <div className="space-y-4">
                        {emails.map((email) => (
                          <div key={email.id} className="p-4 border rounded-3xl hover:bg-gray-50">
                            <p><strong>Para:</strong> {email.to_email}</p>
                            <p><strong>Asunto:</strong> {email.subject}</p>
                            <p className="truncate">{email.body}</p>
                            <p className="text-sm text-gray-500">{new Date(email.sent_at).toLocaleString()}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {view === 'spam' && (
                    <div className="bg-white p-8 rounded-3xl shadow-lg">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Spam ({currentAccount})</h2>
                      <div className="space-y-4">
                        {emails.map((email) => (
                          <div key={email.id} className="p-4 border rounded-3xl hover:bg-gray-50">
                            <p><strong>De:</strong> {email.from_email}</p>
                            <p><strong>Asunto:</strong> {email.subject}</p>
                            <p className="truncate">{email.body}</p>
                            <p className="text-sm text-gray-500">{new Date(email.sent_at).toLocaleString()}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {view === 'drafts' && (
                    <div className="bg-white p-8 rounded-3xl shadow-lg">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Borradores ({currentAccount})</h2>
                      <div className="space-y-4">
                        {emails.map((email) => (
                          <div key={email.id} className="p-4 border rounded-3xl hover:bg-gray-50">
                            <p><strong>Para:</strong> {email.to_email}</p>
                            <p><strong>Asunto:</strong> {email.subject}</p>
                            <p className="truncate">{email.body}</p>
                            <p className="text-sm text-gray-500">{new Date(email.sent_at).toLocaleString()}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {view === 'compose' && (
                    <div className="bg-white p-8 rounded-3xl shadow-lg">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Redactar Correo</h2>
                      <select
                        value={emailData.from || currentAccount || accounts[0]?.email}
                        onChange={(e) => setEmailData({ ...emailData, from: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        {accounts.map((account) => (
                          <option key={account.email} value={account.email}>{account.email}</option>
                        ))}
                      </select>
                      <input
                        type="email"
                        placeholder="Para (ej: usuario@zephiryx.com)"
                        value={emailData.to}
                        onChange={(e) => setEmailData({ ...emailData, to: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="text"
                        placeholder="Asunto"
                        value={emailData.subject}
                        onChange={(e) => setEmailData({ ...emailData, subject: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <textarea
                        placeholder="Mensaje"
                        value={emailData.body}
                        onChange={(e) => setEmailData({ ...emailData, body: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl h-40 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <div className="flex space-x-4">
                        <button
                          onClick={() => { setEmailData({ ...emailData, is_draft: false }); sendEmail(); }}
                          className="bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button"
                        >
                          Enviar
                        </button>
                        <button
                          onClick={() => { setEmailData({ ...emailData, is_draft: true }); sendEmail(); }}
                          className="bg-gray-600 text-white p-3 rounded-3xl hover:bg-gray-700 modern-button"
                        >
                          Guardar como borrador
                        </button>
                        <button
                          onClick={() => setView('inbox')}
                          className="bg-red-600 text-white p-3 rounded-3xl hover:bg-red-700 modern-button"
                        >
                          Cancelar
                        </button>
                      </div>
                    </div>
                  )}
                  {view === 'profile' && (
                    <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-lg mx-auto">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Perfil</h2>
                      <img
                        src={profile?.profile_picture || `https://via.placeholder.com/100?text=${profile?.display_name?.charAt(0)?.toUpperCase() || 'U'}&bg=3b82f6`}
                        alt="Profile"
                        className="w-24 h-24 rounded-full mx-auto mb-6"
                      />
                      <input
                        type="text"
                        placeholder="Nombre para mostrar"
                        value={profileData.display_name}
                        onChange={(e) => setProfileData({ ...profileData, display_name: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="url"
                        placeholder="URL de la foto de perfil (opcional)"
                        value={profileData.profile_picture}
                        onChange={(e) => setProfileData({ ...profileData, profile_picture: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="password"
                        placeholder="Nueva contraseña (opcional)"
                        value={profileData.password}
                        onChange={(e) => setProfileData({ ...profileData, password: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={updateProfile}
                        className="w-full bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button"
                      >
                        Actualizar Perfil
                      </button>
                    </div>
                  )}
                  {view === 'add-account' && (
                    <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-lg mx-auto">
                      <h2 className="text-2xl font-semibold mb-6 text-blue-600">Añadir Cuenta</h2>
                      <input
                        type="email"
                        placeholder="Correo (ej: usuario@zephiryx.com)"
                        value={addAccountData.email}
                        onChange={(e) => setAddAccountData({ ...addAccountData, email: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="password"
                        placeholder="Contraseña"
                        value={addAccountData.password}
                        onChange={(e) => setAddAccountData({ ...addAccountData, password: e.target.value })}
                        className="w-full p-3 mb-4 border rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={addAccount}
                        className="w-full bg-blue-600 text-white p-3 rounded-3xl hover:bg-blue-700 modern-button"
                      >
                        Añadir Cuenta
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
